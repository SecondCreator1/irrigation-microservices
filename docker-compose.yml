services:
  # 1. MySQL démarre EN PREMIER
  mysql:
    image: mysql:8.0
    container_name: mysql-db
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: irrigation
    ports:
      - "3306:3306"
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - irrigation-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # 2. Eureka Server démarre APRÈS MySQL
  eureka-server:
    build:
      context: ./backend/eureka-server
      dockerfile: Dockerfile
    ports:
      - "8761:8761"
    environment:
      - SPRING_APPLICATION_NAME=eureka-server
    networks:
      - irrigation-network
    depends_on:
      mysql:
        condition: service_healthy
    restart: on-failure

  # 3. Config Server démarre APRÈS Eureka
  config-server:
    build:
      context: ./backend/config-server
      dockerfile: Dockerfile
    ports:
      - "8888:8888"
    environment:
      - SPRING_APPLICATION_NAME=config-server
    networks:
      - irrigation-network
    depends_on:
      - eureka-server
    restart: on-failure
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8888/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 10

  # 4. Meteo Service démarre APRÈS Config Server
  meteo-service:
    build:
      context: ./backend/meteo-service
      dockerfile: Dockerfile
    ports:
      - "8081:8081"
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/meteoservice
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root
    depends_on:
      mysql:
        condition: service_healthy
      config-server:
        condition: service_healthy
    networks:
      - irrigation-network
    restart: on-failure

  # 5. Arrosage Service démarre APRÈS Config Server
  arrosage-service:
    build:
      context: ./backend/arrosage-service
      dockerfile: Dockerfile
    ports:
      - "8082:8082"
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/arrosageservice
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root
    depends_on:
      mysql:
        condition: service_healthy
      config-server:
        condition: service_healthy
    networks:
      - irrigation-network
    restart: on-failure

  # 6. Gateway démarre APRÈS tous les services
  gateway:
    build:
      context: ./backend/Gateway
      dockerfile: Dockerfile
    ports:
      - "9094:9094"
    depends_on:
      - config-server
      - meteo-service
      - arrosage-service
    networks:
      - irrigation-network
    restart: on-failure

  # 7. Frontend démarre EN DERNIER
  frontend:
    build:
      context: ./frontend/irrigation-frontend
      dockerfile: Dockerfile.frontend
    ports:
      - "4200:80"
    depends_on:
      - gateway
    networks:
      - irrigation-network

volumes:
  mysql-data:

networks:
  irrigation-network:
    driver: bridge
