<div class="page-container">
  <div class="page-header">
    <h1>Programmes d'Arrosage</h1>
    <button mat-raised-button color="primary" (click)="openAddDialog()">
      <mat-icon>add</mat-icon>
      Nouveau programme
    </button>
  </div>

  <mat-card class="filter-card">
    <mat-card-content>
      <div class="filters">
        <mat-form-field appearance="outline">
          <mat-label>ID Parcelle</mat-label>
          <input matInput type="number" [(ngModel)]="parcelleId" (change)="onParcelleChange()">
        </mat-form-field>
      </div>
    </mat-card-content>
  </mat-card>

  <mat-card class="table-card">
    <mat-card-content>
      <div *ngIf="isLoading" class="loading-container">
        <mat-spinner></mat-spinner>
      </div>

      <table mat-table [dataSource]="programmes" *ngIf="!isLoading" class="full-width-table">
        <ng-container matColumnDef="id">
          <th mat-header-cell *matHeaderCellDef> ID </th>
          <td mat-cell *matCellDef="let programme"> {{programme.id}} </td>
        </ng-container>

        <ng-container matColumnDef="parcelleId">
          <th mat-header-cell *matHeaderCellDef> Parcelle </th>
          <td mat-cell *matCellDef="let programme">
            Parcelle #{{programme.parcelleId}}
          </td>
        </ng-container>

        <ng-container matColumnDef="datePlanifiee">
          <th mat-header-cell *matHeaderCellDef> Date Planifiée </th>
          <td mat-cell *matCellDef="let programme"> {{programme.datePlanifiee | date:'dd/MM/yyyy'}} </td>
        </ng-container>

        <ng-container matColumnDef="duree">
          <th mat-header-cell *matHeaderCellDef> Durée </th>
          <td mat-cell *matCellDef="let programme"> {{programme.duree || 'N/A'}} min </td>
        </ng-container>

        <ng-container matColumnDef="volumePrevu">
          <th mat-header-cell *matHeaderCellDef> Volume </th>
          <td mat-cell *matCellDef="let programme"> {{programme.volumePrevu || 'N/A'}} L </td>
        </ng-container>

        <ng-container matColumnDef="statut">
          <th mat-header-cell *matHeaderCellDef> Statut </th>
          <td mat-cell *matCellDef="let programme">
            <mat-chip-listbox>
              <mat-chip-option [color]="getStatutColor(programme.statut)" selected>
                {{programme.statut}}
              </mat-chip-option>
            </mat-chip-listbox>
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef> Actions </th>
          <td mat-cell *matCellDef="let programme">
            <!-- ✅ BOUTON TERMINER (visible seulement si pas encore terminé) -->
            <button 
              mat-icon-button 
              color="accent" 
              (click)="markAsCompleted(programme)" 
              matTooltip="Terminer et enregistrer au journal"
              *ngIf="programme.statut !== StatutProgramme.TERMINE && programme.statut !== StatutProgramme.ANNULE">
              <mat-icon>check_circle</mat-icon>
            </button>
            
            <button mat-icon-button color="primary" (click)="openEditDialog(programme)" matTooltip="Modifier">
              <mat-icon>edit</mat-icon>
            </button>
            
            <button mat-icon-button color="warn" (click)="deleteProgramme(programme.id!)" matTooltip="Supprimer">
              <mat-icon>delete</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>

      <div *ngIf="!isLoading && programmes.length === 0" class="no-data">
        <mat-icon>schedule</mat-icon>
        <p>Aucun programme d'arrosage disponible</p>
      </div>
    </mat-card-content>
  </mat-card>
</div>
